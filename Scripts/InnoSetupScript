; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

#define MyAppName "Observer Collection Forms"
#define MyAppVersion "0.5.0"
#define MyAppPublisher "IOTC"
#define MyAppURL "http://www.iotc.org"
#define MyAppIcoName "ObserverCollectionForms.ico"
#define MyAppStartScript "start.bat"
#define MyAppStopScript "stop.bat"
#define MinJRE "1.6"

[Setup]
; NOTE: The value of AppId uniquely identifies this application.
; Do not use the same AppId value in installers for other applications.
; (To generate a new GUID, click Tools | Generate GUID inside the IDE.)
AppId={{57B2C0D0-508C-4179-A2E0-0815ED53F156}
AppName={#MyAppName}
AppVersion={#MyAppVersion}
;AppVerName={#MyAppName} {#MyAppVersion}
AppPublisher={#MyAppPublisher}
AppPublisherURL={#MyAppURL}
AppSupportURL={#MyAppURL}
AppUpdatesURL={#MyAppURL}
DefaultDirName={pf}\{#MyAppName}
DisableProgramGroupPage=yes
OutputBaseFilename=setup
Compression=lzma
SolidCompression=yes
PrivilegesRequired=admin

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"

[Registry]
Root: HKLM; Subkey: "Software\IOTC\ObserverCollectionForms\Settings"; ValueType: string; ValueName: "InstallPath"; ValueData: "{app}"
Root: HKCU; Subkey: "Environment"; ValueType:string; ValueName:"PATH"; ValueData:"{olddata};{pf}\Java\bin"; Flags: preservestringtype
; Root: HKCU; Subkey: "Environment"; ValueType:string; ValueName:"JAVA_HOME"; ValueData:"{pf}\Java"; Flags: preservestringtype
Root: HKCU; Subkey: "Environment"; ValueType:string; ValueName:"CATALINA_HOME"; ValueData:"{localappdata}\tomcat"; Flags: preservestringtype

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

[Files]
Source: "ROS\Files\apache-tomcat-7.0.69_x64\*.*"; DestDir: "{localappdata}\tomcat"; Check: IsWin64; Flags: ignoreversion recursesubdirs createallsubdirs 
Source: "ROS\Files\apache-tomcat-7.0.69_x86\*.*"; DestDir: "{localappdata}\tomcat"; Check: not IsWin64; Flags: ignoreversion recursesubdirs createallsubdirs
Source: "ROS\Files\{#MyAppStartScript}"; DestDir: "{app}"; DestName: "start.bat"; 
Source: "ROS\Files\{#MyAppStopScript}"; DestDir: "{app}"; DestName: "stop.bat";
Source: "ROS\Files\{#MyAppIcoName}"; DestDir: "{app}"

[Icons]
Name: "{commondesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppStartScript}"; IconFilename: "{app}\{#MyAppIcoName}"; Tasks: desktopicon

[Setup]
ChangesEnvironment=yes

[Run]     
; install tomcat as services
Filename: "{localappdata}\tomcat\bin\service.bat"; Parameters: "install ObserverCollectionForms"   
Filename: "{app}\start.bat"; Description: {cm:LaunchProgram,{cm:AppName}}; Flags: nowait postinstall skipifsilent; Check: IsJREInstalled

[UninstallRun]   
; uninstall tomcat as services  
Filename: "{app}\stop.bat";
Filename: "set"; Parameters: "CATALINA_HOME={localappdata}\tomcat"
Filename: "{localappdata}\tomcat\bin\service.bat"; Parameters: "uninstall ObserverCollectionForms"

[UninstallDelete]
Type: filesandordirs; Name: "{localappdata}\tomcat"

[CustomMessages]
AppName=ObserverCollectionForms
LaunchProgram=Start ObserverCollectionForms after finishing installation


[Code]
#define MinJRE "1.6"
#define WebJRE "http://www.oracle.com/technetwork/java/javase/downloads/jre6downloads-1902815.html"

function IsJREInstalled: Boolean;
var
  JREVersion: string;
  JREPath: string;
begin
  // read JRE version
  RegDeleteValue(HKCU, 'Environment', 'JRE_HOME');
  RegDeleteValue(HKCU, 'Environment', 'JDK_HOME');
    
  Result := RegQueryStringValue(HKLM32, 'Software\JavaSoft\Java Runtime Environment',
    'CurrentVersion', JREVersion);
  // if the previous reading failed and we're on 64-bit Windows, try to read 
  // the JRE version from WOW node
  if not Result and IsWin64 then
    Result := RegQueryStringValue(HKLM64, 'Software\JavaSoft\Java Runtime Environment',
      'CurrentVersion', JREVersion);
  // if the JRE version was read, check if it's at least the minimum one
  if Result then
    Result := CompareStr(JREVersion, '{#MinJRE}') >= 0;
    if IsWin64 then
      RegQueryStringValue(HKLM64, 'Software\JavaSoft\Java Runtime Environment\' + JREVersion,
      'JavaHome', JREPath);
    if not isWin64 then
      RegQueryStringValue(HKLM32, 'Software\JavaSoft\Java Runtime Environment\' + JREVersion,
      'JavaHome', JREPath);
    RegWriteStringValue(HKCU, 'Environment', 'JRE_HOME', JREPath)
    Result := CompareStr(JREVersion, '{#MinJRE}') >= 0;
end;

function InitializeSetup: Boolean;
var
  ErrorCode: Integer;
begin
  Result := True;
  // check if JRE is installed; if not, then...
  if not IsJREInstalled then
  begin
    // show a message box and let user to choose if they want to download JRE;
    // if so, go to its download site and exit setup; continue otherwise
    if MsgBox('Java is required. Do you want to download it now ?',
      mbConfirmation, MB_YESNO) = IDYES then
    begin
      Result := False;
      ShellExec('', '{#WebJRE}', '', '', SW_SHOWNORMAL, ewNoWait, ErrorCode);
    end;
  end;
end;

